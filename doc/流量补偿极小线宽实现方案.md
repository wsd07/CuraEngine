# æµé‡è¡¥å¿æå°çº¿å®½å®ç°æ–¹æ¡ˆ

## ğŸ¯ ç›®æ ‡å®ç°

å®ç°çœŸæ­£çš„"æ— é™åˆ¶"min_wall_line_widthï¼Œå…è®¸ç”¨æˆ·è®¾ç½®ä»»æ„å°çš„çº¿å®½å€¼ï¼Œé€šè¿‡æµé‡è¡¥å¿æŠ€æœ¯ç¡®ä¿ï¼š
1. **ç‰©ç†å¯è¡Œæ€§**ï¼šå³ä½¿æå°çš„ç¼éš™ä¹Ÿèƒ½è¢«å¡«å……
2. **ç®—æ³•ç¨³å®šæ€§**ï¼šä¸ä¼šå› ä¸ºå‚æ•°è¿‡å°å¯¼è‡´åˆ‡ç‰‡å´©æºƒ
3. **ç”¨æˆ·å‹å¥½æ€§**ï¼šGUIä¸å†é™åˆ¶ç”¨æˆ·çš„åˆ›æ„

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ€æƒ³

**åˆ†ç¦»è·¯å¾„è§„åˆ’å’ŒæŒ¤å‡ºæ§åˆ¶**ï¼š
- **è·¯å¾„è§„åˆ’**ï¼šä½¿ç”¨ç®—æ³•ç¨³å®šçš„æœ€å°çº¿å®½è¿›è¡Œå‡ ä½•è®¡ç®—
- **æŒ¤å‡ºæ§åˆ¶**ï¼šé€šè¿‡flowå‚æ•°è°ƒæ•´å®é™…æŒ¤å‡ºé‡

**æ•°å­¦åŸç†**ï¼š
```
å®é™…æŒ¤å‡ºå®½åº¦ = è·¯å¾„è§„åˆ’å®½åº¦ Ã— flow_ratio
flow_ratio = ç›®æ ‡å®½åº¦ / è·¯å¾„è§„åˆ’å®½åº¦
```

### 1. æ–°å¢FlowCompensatedBeadingStrategy

**ä½ç½®**: `CuraEngine/src/BeadingStrategy/FlowCompensatedBeadingStrategy.cpp`

**åŠŸèƒ½**:
- æ£€æµ‹éœ€è¦æµé‡è¡¥å¿çš„æå°çº¿å®½
- ä½¿ç”¨ç¨³å®šçš„æœ€å°å®½åº¦è¿›è¡Œè·¯å¾„è§„åˆ’
- è®¡ç®—å¹¶åº”ç”¨é€‚å½“çš„flow_ratio

**å…³é”®å‚æ•°**:
- `min_target_width_`: ç”¨æˆ·è®¾ç½®çš„ç›®æ ‡æœ€å°çº¿å®½
- `min_stable_width_`: ç®—æ³•ç¨³å®šçš„æœ€å°çº¿å®½ï¼ˆé€šå¸¸ä¸ºå–·å¤´ç›´å¾„çš„25%ï¼‰
- `max_flow_compensation_ratio_`: æœ€å¤§æµé‡è¡¥å¿æ¯”ä¾‹ï¼ˆé˜²æ­¢è¿‡åº¦è¡¥å¿ï¼‰

### 2. æ‰©å±•BeadingStrategy::Beadingç»“æ„

**æ–°å¢å­—æ®µ**:
```cpp
std::vector<double> flow_ratios; // æ¯ä¸ªbeadçš„æµé‡æ¯”ä¾‹
```

**è‡ªåŠ¨åˆå§‹åŒ–**:
```cpp
void ensureFlowRatiosSize() {
    if (flow_ratios.size() != bead_widths.size()) {
        flow_ratios.resize(bead_widths.size(), 1.0);
    }
}
```

### 3. æ‰©å±•ExtrusionJunctionç»“æ„

**æ–°å¢å­—æ®µ**:
```cpp
double flow_ratio_; // æµé‡æ¯”ä¾‹ï¼ˆ1.0 = æ­£å¸¸æµé‡ï¼‰
```

**æ„é€ å‡½æ•°æ›´æ–°**:
```cpp
ExtrusionJunction(const Point2LL p, const coord_t w, const coord_t perimeter_index, const double flow_ratio = 1.0);
```

### 4. ä¿®æ”¹WideningBeadingStrategy

**æ–°ç­–ç•¥**:
```cpp
if (thickness > 0) {
    coord_t output_width;
    double flow_ratio = 1.0;
    
    if (thickness >= min_input_width_) {
        // åšåº¦è¶³å¤Ÿï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        output_width = std::max(thickness, min_output_width_);
    } else {
        // åšåº¦å¾ˆå°ï¼Œä½¿ç”¨æµé‡è¡¥å¿
        const coord_t min_stable_width = std::max(min_output_width_, optimal_width_ / 4);
        output_width = min_stable_width;
        flow_ratio = static_cast<double>(thickness) / static_cast<double>(min_stable_width);
        flow_ratio = std::max(0.05, std::min(1.0, flow_ratio)); // é™åˆ¶åœ¨5%-100%
    }
    
    ret.bead_widths.emplace_back(output_width);
    ret.flow_ratios.emplace_back(flow_ratio);
    ret.toolpath_locations.emplace_back(thickness / 2);
}
```

### 5. æ›´æ–°LayerPlan::addVariableWidthLines

**ä½¿ç”¨flowä¿¡æ¯**:
```cpp
for (const auto& junction_n : wall) {
    const Ratio width_factor{ static_cast<Ratio::value_type>(junction_n.w_) / Ratio{ static_cast<Ratio::value_type>(path_config.getLineWidth()) } };
    const Ratio flow{ junction_n.flow_ratio_ }; // ä½¿ç”¨ExtrusionJunctionä¸­çš„flow_ratio
    
    if (junction_n.flow_ratio_ < 1.0) {
        spdlog::debug("ã€æµé‡è¡¥å¿ã€‘ä½ç½®({}, {})ï¼Œçº¿å®½={:.2f}mmï¼Œæµé‡æ¯”ä¾‹={:.3f}", 
                     junction_n.p_.X, junction_n.p_.Y, INT2MM(junction_n.w_), junction_n.flow_ratio_);
    }
    
    addExtrusionMove(junction_n.p_, path_config, space_fill_type, flow, width_factor);
}
```

### 6. æ›´æ–°GUIå‚æ•°é™åˆ¶

**fdmprinter.def.json**:
```json
"min_wall_line_width": {
    "minimum_value": "0.001",
    "minimum_value_warning": "max(wall_line_width_0, wall_line_width_x) * 0.2",
    "description": "... NEW: Very small values are now supported through flow compensation - the slicer will automatically adjust extrusion flow to achieve the target width."
}
```

## ğŸ“Š å·¥ä½œæµç¨‹

### 1. å‚æ•°æ£€æµ‹é˜¶æ®µ

```
ç”¨æˆ·è®¾ç½®: min_wall_line_width = 0.1mm
å–·å¤´ç›´å¾„: 0.8mm
ç®—æ³•ç¨³å®šæœ€å°å®½åº¦: 0.2mm (25%)
```

### 2. BeadingStrategyè®¡ç®—é˜¶æ®µ

```
ç›®æ ‡åšåº¦: 0.1mm
æ£€æµ‹: 0.1mm < 0.2mm (éœ€è¦æµé‡è¡¥å¿)
è·¯å¾„è§„åˆ’å®½åº¦: 0.2mm
flow_ratio: 0.1 / 0.2 = 0.5
```

### 3. è·¯å¾„ç”Ÿæˆé˜¶æ®µ

```
ExtrusionJunction {
    p_: (x, y),
    w_: 200 (0.2mm),
    perimeter_index_: 0,
    flow_ratio_: 0.5
}
```

### 4. Gä»£ç ç”Ÿæˆé˜¶æ®µ

```
G1 X... Y... E... F... ; è·¯å¾„æŒ‰0.2mmå®½åº¦è§„åˆ’
; ä½†æŒ¤å‡ºé‡æŒ‰0.5å€è®¡ç®—ï¼Œå®é™…æŒ¤å‡ºå®½åº¦çº¦0.1mm
```

## ğŸ¯ ä¼˜åŠ¿åˆ†æ

### 1. ç‰©ç†å¯è¡Œæ€§

**ä¼ ç»Ÿæ–¹æ³•**:
- è®¾ç½®0.1mmçº¿å®½ â†’ ç®—æ³•å´©æºƒ
- æ— æ³•å¡«å……æå°ç¼éš™ â†’ æ¨¡å‹æœ‰ç©ºæ´

**æ–°æ–¹æ³•**:
- è®¾ç½®0.1mmçº¿å®½ â†’ è‡ªåŠ¨ä½¿ç”¨0.2mmè·¯å¾„ + 0.5å€æµé‡
- æˆåŠŸå¡«å……æå°ç¼éš™ â†’ æ¨¡å‹å®å¿ƒ

### 2. ç®—æ³•ç¨³å®šæ€§

**ä¼ ç»Ÿæ–¹æ³•**:
- BeadingStrategyè®¡ç®—å¼‚å¸¸
- getTransitionAnchorPosè¿”å›æå€¼
- SkeletalTrapezoidationæ–­è¨€å¤±è´¥

**æ–°æ–¹æ³•**:
- å§‹ç»ˆä½¿ç”¨ç¨³å®šçš„è·¯å¾„å®½åº¦è¿›è¡Œå‡ ä½•è®¡ç®—
- æ‰€æœ‰ç®—æ³•ä¿æŒç¨³å®š
- ä¸ä¼šå‡ºç°æ–­è¨€å¤±è´¥

### 3. ç”¨æˆ·ä½“éªŒ

**ä¼ ç»Ÿæ–¹æ³•**:
- GUIé™åˆ¶ç”¨æˆ·è¾“å…¥
- é”™è¯¯æç¤ºä¸å‹å¥½
- æ— æ³•å®ç°è®¾è®¡æ„å›¾

**æ–°æ–¹æ³•**:
- ç”¨æˆ·å¯ä»¥è®¾ç½®ä»»æ„å°çš„å€¼
- è‡ªåŠ¨ä¼˜åŒ–ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- å®Œå…¨å®ç°è®¾è®¡æ„å›¾

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æµé‡è¡¥å¿èŒƒå›´

**å®‰å…¨èŒƒå›´**: 5% - 100%
- **æœ€å°5%**: é˜²æ­¢å®Œå…¨æ— æŒ¤å‡º
- **æœ€å¤§100%**: æ­£å¸¸æµé‡ä¸Šé™

**è®¡ç®—å…¬å¼**:
```cpp
flow_ratio = std::max(0.05, std::min(1.0, target_width / stable_width));
```

### ç¨³å®šå®½åº¦é€‰æ‹©

**è®¡ç®—å…¬å¼**:
```cpp
min_stable_width = std::max(min_output_width_, optimal_width_ / 4);
```

**åŸç†**:
- ä¸å°äºåŸå§‹æœ€å°è¾“å‡ºå®½åº¦
- ä¸å°äºæœ€ä¼˜å®½åº¦çš„25%
- ç¡®ä¿ç®—æ³•æ•°å€¼ç¨³å®šæ€§

### å…¼å®¹æ€§ä¿è¯

**å‘åå…¼å®¹**:
- æ­£å¸¸å‚æ•°å€¼ï¼ˆâ‰¥ç¨³å®šå®½åº¦ï¼‰ï¼šè¡Œä¸ºå®Œå…¨ä¸å˜
- flow_ratioé»˜è®¤å€¼1.0ï¼šä¸å½±å“ç°æœ‰é€»è¾‘
- æ‰€æœ‰ç°æœ‰BeadingStrategyï¼šè‡ªåŠ¨æ”¯æŒ

**æ¸è¿›å¼éƒ¨ç½²**:
- å¯ä»¥é€æ­¥å¯ç”¨æ–°åŠŸèƒ½
- ä¸å½±å“ç°æœ‰ç”¨æˆ·é…ç½®
- å®Œå…¨å¯é€‰çš„ä¼˜åŒ–

## ğŸ‰ å®é™…æ•ˆæœ

### æµ‹è¯•ç”¨ä¾‹

| å–·å¤´ç›´å¾„ | ç›®æ ‡çº¿å®½ | è·¯å¾„å®½åº¦ | flow_ratio | ç»“æœ |
|----------|----------|----------|------------|------|
| 0.8mm | 0.05mm | 0.2mm | 0.25 | âœ… æˆåŠŸå¡«å…… |
| 0.8mm | 0.1mm | 0.2mm | 0.5 | âœ… æˆåŠŸå¡«å…… |
| 0.8mm | 0.2mm | 0.2mm | 1.0 | âœ… æ­£å¸¸æ‰“å° |
| 0.8mm | 0.4mm | 0.4mm | 1.0 | âœ… æ­£å¸¸æ‰“å° |

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[info] ã€æå°çº¿å®½æ¨¡å¼ã€‘min_bead_width=0.100mmï¼Œå°†ä½¿ç”¨æµé‡è¡¥å¿ç­–ç•¥å®ç°
[debug] WideningBeadingStrategy: æå°åšåº¦0.10mmï¼Œä½¿ç”¨ç¨³å®šå®½åº¦0.20mmï¼Œæµé‡æ¯”ä¾‹0.500
[debug] ã€æµé‡è¡¥å¿ã€‘ä½ç½®(1234, 5678)ï¼Œçº¿å®½=0.20mmï¼Œæµé‡æ¯”ä¾‹=0.500
```

## ğŸš€ æ€»ç»“

è¿™ä¸ªå®ç°æ–¹æ¡ˆå½»åº•è§£å†³äº†min_wall_line_widthçš„é™åˆ¶é—®é¢˜ï¼š

1. **æŠ€æœ¯çªç ´**: åˆ†ç¦»äº†è·¯å¾„è§„åˆ’å’ŒæŒ¤å‡ºæ§åˆ¶
2. **ç”¨æˆ·å‹å¥½**: æ”¯æŒä»»æ„å°çš„çº¿å®½è®¾ç½®
3. **ç®—æ³•ç¨³å®š**: ä¸ä¼šå› ä¸ºæå°å‚æ•°å¯¼è‡´å´©æºƒ
4. **ç‰©ç†å¯è¡Œ**: çœŸæ­£èƒ½å¤Ÿå¡«å……æå°ç¼éš™
5. **å®Œå…¨å…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½å’Œé…ç½®

ç”¨æˆ·ç°åœ¨å¯ä»¥è‡ªç”±è®¾ç½®æå°çš„min_wall_line_widthå€¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€šè¿‡æµé‡è¡¥å¿æŠ€æœ¯å®ç°ï¼Œç¡®ä¿æ¨¡å‹çš„æ¯ä¸€ä¸ªç»†å°ç¼éš™éƒ½èƒ½è¢«å®Œç¾å¡«å……ï¼
