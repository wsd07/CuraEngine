# 安全日志重构脚本使用说明

## 🎯 脚本特点

这个新的重构脚本吸取了之前的教训，具有以下安全特性：

1. **完整备份**: 每个文件修改前都会自动备份
2. **详细日志**: 记录每一处修改的详细信息
3. **完整撤销**: 可以完全撤销所有修改
4. **逐步处理**: 可以指定处理特定文件
5. **状态查看**: 可以查看当前处理状态
6. **错误恢复**: 出错时不会影响其他文件

## 📋 使用方法

### 1. 处理所有文件
```bash
cd CuraEngine
python3 scripts/safe_logging_refactor.py process
```

### 2. 处理指定文件
```bash
cd CuraEngine
python3 scripts/safe_logging_refactor.py process src/Application.cpp src/LayerPlan.cpp
```

### 3. 查看处理状态
```bash
cd CuraEngine
python3 scripts/safe_logging_refactor.py status
```

### 4. 撤销所有修改
```bash
cd CuraEngine
python3 scripts/safe_logging_refactor.py undo
```

## 📊 日志记录格式

脚本会生成 `refactor_log.json` 文件，记录所有修改：

```json
{
  "version": "1.0",
  "start_time": "2024-01-01T10:00:00",
  "modifications": [
    {
      "filepath": "src/Application.cpp",
      "timestamp": "2024-01-01T10:00:01",
      "category": "DEVELOPMENT",
      "original_hash": "abc123...",
      "new_hash": "def456...",
      "backup_path": "refactor_backups/src/Application.cpp",
      "modifications": [
        {
          "type": "spdlog_replacement",
          "line_number": 96,
          "original": "spdlog::error(\"Unknown option: {}\", str);",
          "new": "CURA_ERROR(\"Unknown option: {}\", str);",
          "level": "error",
          "category": "DEVELOPMENT",
          "message": "Unknown option: {}"
        },
        {
          "type": "include_addition",
          "line_number": 28,
          "content": "#include \"utils/DebugManager.h\""
        }
      ],
      "modification_count": 2
    }
  ],
  "completed_files": ["src/Application.cpp"],
  "failed_files": []
}
```

## 🔧 修改类型

脚本会进行以下类型的修改：

### 1. spdlog调用替换
- `spdlog::debug(...)` → `CURA_DEBUG(CATEGORY, ...)`
- `spdlog::info(...)` → `CURA_INFO(...)`
- `spdlog::warn(...)` → `CURA_WARN(...)`
- `spdlog::error(...)` → `CURA_ERROR(...)`

### 2. 头文件添加
- 自动添加 `#include "utils/DebugManager.h"`

### 3. 智能分类
根据文件名自动选择合适的调试分类：
- `BeadingStrategy*.cpp` → `BEADING_STRATEGY`
- `LayerPlan*.cpp` → `LAYER_PLAN`
- `FffGcodeWriter.cpp` → `GCODE_GENERATION`
- 等等...

## 🛡️ 安全机制

### 1. 文件备份
每个文件修改前都会备份到 `refactor_backups/` 目录

### 2. 哈希验证
记录文件修改前后的MD5哈希，确保完整性

### 3. 逐文件处理
每个文件独立处理，一个文件出错不影响其他文件

### 4. 详细日志
记录每一处修改的详细信息，便于审查和撤销

### 5. 完整撤销
可以完全撤销所有修改，恢复到原始状态

## 📝 使用示例

### 示例1: 测试单个文件
```bash
# 先测试一个文件
python3 scripts/safe_logging_refactor.py process src/Application.cpp

# 查看结果
python3 scripts/safe_logging_refactor.py status

# 如果满意，继续处理其他文件
python3 scripts/safe_logging_refactor.py process src/LayerPlan.cpp

# 如果不满意，撤销修改
python3 scripts/safe_logging_refactor.py undo
```

### 示例2: 分批处理
```bash
# 先处理核心文件
python3 scripts/safe_logging_refactor.py process src/Application.cpp src/FffGcodeWriter.cpp

# 编译测试
cd build && ninja

# 如果编译成功，继续处理BeadingStrategy文件
python3 scripts/safe_logging_refactor.py process src/BeadingStrategy/*.cpp

# 继续编译测试...
```

## ⚠️ 注意事项

1. **先备份整个项目**: 虽然脚本有备份机制，但建议先用git提交当前状态
2. **逐步验证**: 建议分批处理文件，每批处理后都编译测试
3. **检查日志**: 处理完成后检查 `refactor_log.json` 确认修改正确
4. **测试功能**: 修改后要测试相关功能是否正常

## 🔄 撤销流程

如果需要撤销修改：

1. **停止当前操作**
2. **运行撤销命令**: `python3 scripts/safe_logging_refactor.py undo`
3. **验证撤销结果**: 检查文件是否恢复到原始状态
4. **清理**: 撤销成功后会自动删除日志文件和备份目录

## 📈 处理进度

脚本会显示详细的处理进度：

```
找到 156 个C++文件
处理文件: src/Application.cpp
  分类: DEVELOPMENT
    第96行: error -> spdlog_replacement
    第113行: error -> spdlog_replacement
    第258行: error -> spdlog_replacement
  ✅ 完成，4处修改
处理文件: src/LayerPlan.cpp
  分类: LAYER_PLAN
    第1079行: info -> spdlog_replacement
    第1229行: debug -> spdlog_replacement
  ✅ 完成，3处修改
...
总结: 成功处理了 52 个文件
日志文件: refactor_log.json
```

这个新脚本比之前的版本安全得多，可以放心使用！
